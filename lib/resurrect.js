/**
 * # ResurrectJS
 * @version 1.0.3
 * @license Public Domain
 */

function Resurrect(e){this.table=null,this.prefix="#",this.cleanup=!1,this.revive=!0;for(var r in e)e.hasOwnProperty(r)&&(this[r]=e[r]);this.refcode=this.prefix+"id",this.origcode=this.prefix+"original",this.buildcode=this.prefix+".",this.valuecode=this.prefix+"v"}Resurrect.GLOBAL=(0,eval)("this"),Resurrect.escapeRegExp=function(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},Resurrect.prototype.Error=function(e){this.message=e||"",this.stack=(new Error).stack},Resurrect.prototype.Error.prototype=Object.create(Error.prototype),Resurrect.prototype.Error.prototype.name="ResurrectError",Resurrect.NamespaceResolver=function(e){this.scope=e},Resurrect.NamespaceResolver.prototype.getPrototype=function(e){var r=this.scope[e];if(r)return r.prototype;throw new Resurrect.prototype.Error("Unknown constructor: "+e)},Resurrect.NamespaceResolver.prototype.getName=function(e){var r=e.constructor.name;if(null==r){var t=/^\s*function\s*([A-Za-z0-9_$]*)/;r=t.exec(e.constructor)[1]}if(""===r){var i="Can't serialize objects with anonymous constructors.";throw new Resurrect.prototype.Error(i)}return"Object"===r||"Array"===r?null:r},Resurrect.prototype.resolver=new Resurrect.NamespaceResolver(Resurrect.GLOBAL),Resurrect.Node=function(e){var r=document.createElement("div");return r.innerHTML=e,r.firstChild},Resurrect.is=function(e){var r="[object "+e+"]";return function(e){return Object.prototype.toString.call(e)===r}},Resurrect.isArray=Resurrect.is("Array"),Resurrect.isString=Resurrect.is("String"),Resurrect.isBoolean=Resurrect.is("Boolean"),Resurrect.isNumber=Resurrect.is("Number"),Resurrect.isFunction=Resurrect.is("Function"),Resurrect.isDate=Resurrect.is("Date"),Resurrect.isRegExp=Resurrect.is("RegExp"),Resurrect.isObject=Resurrect.is("Object"),Resurrect.isAtom=function(e){return!Resurrect.isObject(e)&&!Resurrect.isArray(e)},Resurrect.isPrimitive=function(e){return null==e||Resurrect.isNumber(e)||Resurrect.isString(e)||Resurrect.isBoolean(e)},Resurrect.prototype.ref=function(e){var r={};return r[this.prefix]=void 0===e?-1:e[this.refcode],r},Resurrect.prototype.deref=function(e){return this.table[e[this.prefix]]},Resurrect.prototype.tag=function(e){if(this.revive){var r=this.resolver.getName(e);if(r){var t=Object.getPrototypeOf(e);if(this.resolver.getPrototype(r)!==t)throw new this.Error("Constructor mismatch!");e[this.prefix]=r}}return e[this.refcode]=this.table.length,this.table.push(e),e[this.refcode]},Resurrect.prototype.builder=function(e,r){var t={};return t[this.buildcode]=e,t[this.valuecode]=r,t},Resurrect.prototype.build=function(e){var r=e[this.buildcode].split(/\./).reduce(function(e,r){return e[r]},Resurrect.GLOBAL),t=[null].concat(e[this.valuecode]),i=r.bind.apply(r,t),s=new i;return Resurrect.isPrimitive(s)?s.valueOf():s},Resurrect.prototype.decode=function(e){if(this.prefix in e)return this.deref(e);if(this.buildcode in e)return this.build(e);throw new this.Error("Unknown encoding.")},Resurrect.prototype.isTagged=function(e){return this.refcode in e&&null!=e[this.refcode]},Resurrect.prototype.visit=function(e,r,t){if(Resurrect.isAtom(e))return r(e);if(this.isTagged(e))return this.ref(e);var i=null;if(Resurrect.isArray(e)){i=[],e[this.refcode]=this.tag(i);for(var s=0;s<e.length;s++)i.push(this.visit(e[s],r,t))}else{i=Object.create(Object.getPrototypeOf(e)),e[this.refcode]=this.tag(i);for(var o in e){var n=e[o];if(e.hasOwnProperty(o)){if(t&&void 0!==n&&(n=t.call(e,o,e[o]),void 0===n))continue;i[o]=this.visit(n,r,t)}}}return i[this.origcode]=e,this.ref(i)},Resurrect.prototype.handleAtom=function(e){var r=Resurrect.GLOBAL.Node||function(){};if(Resurrect.isFunction(e))throw new this.Error("Can't serialize functions.");if(e instanceof r){var t=new XMLSerializer;return this.builder("Resurrect.Node",[t.serializeToString(e)])}if(Resurrect.isDate(e))return this.builder("Date",[e.toISOString()]);if(Resurrect.isRegExp(e)){var i=e.toString().match(/\/(.+)\/([gimy]*)/).slice(1);return this.builder("RegExp",i)}return void 0===e?this.ref(void 0):!Resurrect.isNumber(e)||!isNaN(e)&&isFinite(e)?e:this.builder("Number",[e.toString()])},Resurrect.prototype.replacerWrapper=function(e){var r=new RegExp("^"+Resurrect.escapeRegExp(this.prefix));return function(t,i){return r.test(t)?i:e(t,i)}},Resurrect.prototype.stringify=function(e,r,t){if(Resurrect.isFunction(r))r=this.replacerWrapper(r);else if(Resurrect.isArray(r)){var i=r;r=function(e,r){return i.indexOf(e)>=0?r:void 0}}if(Resurrect.isAtom(e))return JSON.stringify(this.handleAtom(e),r,t);this.table=[],this.visit(e,this.handleAtom.bind(this),r);for(var s=0;s<this.table.length;s++)this.cleanup?delete this.table[s][this.origcode][this.refcode]:this.table[s][this.origcode][this.refcode]=null,delete this.table[s][this.refcode],delete this.table[s][this.origcode];var o=this.table;return this.table=null,JSON.stringify(o,null,t)},Resurrect.prototype.fixPrototype=function(e){if(this.prefix in e){var r=e[this.prefix],t=this.resolver.getPrototype(r);if("__proto__"in e)return e.__proto__=t,this.cleanup&&delete e[this.prefix],e;var i=Object.create(t);for(var s in e)e.hasOwnProperty(s)&&s!==this.prefix&&(i[s]=e[s]);return i}return e},Resurrect.prototype.resurrect=function(e){var r=null,t=JSON.parse(e);if(Resurrect.isArray(t)){if(this.table=t,this.revive)for(var i=0;i<this.table.length;i++)this.table[i]=this.fixPrototype(this.table[i]);for(i=0;i<this.table.length;i++){var s=this.table[i];for(var o in s)s.hasOwnProperty(o)&&(Resurrect.isAtom(s[o])||(s[o]=this.decode(s[o])))}r=this.table[0]}else Resurrect.isObject(t)?(this.table=[],r=this.decode(t)):r=t;return this.table=null,r};
if(typeof exports !== 'undefined'){if(typeof module !== 'undefined' && module.exports){exports = module.exports = Resurrect;}exports.Resurrect = Resurrect;}